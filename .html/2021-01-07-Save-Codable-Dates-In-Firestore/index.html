<!DOCTYPE html><html><head><meta charset="utf-8"/><meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/><title>Khan's Blog</title><link href="/resources/index.css" rel="stylesheet"/><link href="/resources/prism.css" rel="stylesheet"/></head><body><article><h2>Lets say we have a Codable object we want to save in Firestore</h2><p>This object has <code>name</code>, and <code>dateUpdated</code> properties. The <code>dateUpdated</code> property is a <code>Date</code> object. The implementation looks like this:</p><pre><code class="language-swift">class Name: Codable {
  var name: String
  var dateUpdated: Date
}
</code></pre><p>To make my life easier, I've added a custom init to this object to convert it from <code>[String: Any]</code> to a <code>Name</code> object.</p><pre><code class="language-swift">extension Name {
  init(dictionary: [String: Any]) throws {
    let data = try JSONSerialization.data(withJSONObject: dictionary, options: .prettyPrinted)
    self = try decoder.decode(Self.self, from: data)
  }
}
</code></pre><p>Pretty easy! Now when I get a response from Firestore I can just convert it to my object like this.</p><pre><code class="language-swift">if let document = snapshot.documents.first {
  let data = document.data()
  let name: Name? = try? Name(data)
}
</code></pre><p>And I have a function that converts the object into a dictionary to save it to firestore.</p><pre><code class="language-swift">func dictionary() throws -&gt; [String: Any] {
  let data = try JSONEncoder().encode(self)
  guard let dictionary = try JSONSerialization.jsonObject(with: data, options: .allowFragments) as? [String: Any] else {
    throw NSError()
  }
  return dictionary
}
</code></pre><h2>What's the problem?</h2><p>If you try saving an object with a <code>Date</code> property to Firestore, Firestore automatically changes the <code>Date</code> to a <code>Timestamp</code>. This probably wouldn't be a problem, unless you're trying to decode that same object where you'll get the error:</p><pre><code class="language-swift">"Invalid type in JSON write (FIRTimestamp)"
</code></pre><p>This is being caused because Swift's Foundation doesn't know how to decode Firestore's <code>Timestamp</code> type from JSON.</p><h2>How do you fix it?</h2><p>It's pretty simple actually, we just tell the <code>JSONDecoder</code> and <code>JSONEncoder</code> to use a special way of encoding/decoding dates. It's just a few line's change for each of the methods in the class.</p><pre><code class="language-swift">extension Name {
  init(dictionary: [String: Any]) throws {
    let data = try JSONSerialization.data(withJSONObject: dictionary, options: .prettyPrinted)
    let decoder = JSONDecoder() // Change
    decoder.dateDecodingStrategy = .secondsSince1970 // Change
    self = try decoder.decode(Self.self, from: data) // Change
  }
  
  func dictionary() throws -&gt; [String: Any] {
    let encoder = JSONEncoder() // Change
    encoder.dateEncodingStrategy = .secondsSince1970 // Change    
    let data = try encoder.encode(self)
    guard let dictionary = try JSONSerialization.jsonObject(with: data, options: .allowFragments) as? [String: Any] else {
      throw NSError()
    }
    return dictionary
  }
}
</code></pre><p>All this is doing is telling swift to save our <code>dateUpdated</code> date as a number instead of an actual date. This way, Firestore doesn't try to change any <code>Date</code> types to <code>Timestamps</code> and we don't get the aforementioned error.</p><p>The change made was instead of using a bare <code>JSONEncoder</code> or <code>JSONDecoder</code>, I changed it to use this:</p><pre><code class="language-swift">let encoder = JSONEncoder()
encoder.dateEncodingStrategy = .secondsSince1970
</code></pre><p>This is applicable to other environments too. If you're building a server using swift, you can use those custom <code>JSONEncoder</code>/<code>JSONDecoder</code> date strategies to encode date types so you know what they'll look like on the server side. The other options for date strategies can be found in the <a href="https://developer.apple.com/documentation/foundation/jsondecoder/2895216-datedecodingstrategy">documentation</a>.</p></article><footer><p>Copyright ©️ Khan Winter 2024</p><p>Built In Swift</p><p><a href="https://twitter.com/thecoolwinter" rel="me">Twitter</a> | <a href="https://threads.net/thecoolwinter" rel="me">Threads</a> | <a href>RSS</a></p></footer></body></html>